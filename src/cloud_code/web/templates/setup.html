{% extends "base.html" %}

{% block title %}Setup - Cloud Code{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Cloud Code Setup</h1>

    <!-- Status Messages -->
    <div id="messages" class="mb-6"></div>

    <!-- Setup Progress -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-medium">Setup Progress</span>
            <span id="progress-text" class="text-sm text-gray-500">0/3 completed</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
    </div>

    <!-- Step 1: GitHub App -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2 text-gray-800">
                <span id="github-status-icon" class="w-6 h-6 rounded-full bg-gray-500 flex items-center justify-center text-white text-sm">1</span>
                GitHub App Configuration
            </h2>
            <span id="github-status" class="text-sm text-gray-500">Not configured</span>
        </div>

        <p class="text-gray-600 mb-4">
            Connect Cloud Code to GitHub to automatically receive issues and create pull requests.
        </p>

        <div id="github-not-configured">
            <div class="bg-gray-50 rounded p-4 mb-4">
                <h3 class="font-medium mb-2 text-gray-700">First, create a GitHub App:</h3>
                <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                    <li>Go to <a href="https://github.com/settings/apps/new" target="_blank" class="text-blue-600 hover:underline">GitHub App Settings</a></li>
                    <li>Set Webhook URL to: <code class="bg-gray-200 px-1 rounded" id="webhook-url"></code></li>
                    <li>Enable permissions: Issues (R/W), Pull Requests (R/W), Contents (R/W)</li>
                    <li>Subscribe to events: Issues, Issue comment, Pull request</li>
                    <li>Generate a private key and copy the credentials below</li>
                </ol>
            </div>

            <form id="github-app-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">App ID</label>
                        <input type="text" name="app_id" required
                            class="w-full border rounded px-3 py-2" placeholder="123456">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Client ID</label>
                        <input type="text" name="client_id" required
                            class="w-full border rounded px-3 py-2" placeholder="Iv1.xxxxxxxxxx">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Client Secret</label>
                    <input type="password" name="client_secret" required
                        class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Webhook Secret</label>
                    <input type="password" name="webhook_secret" required
                        class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Private Key (PEM)</label>
                    <textarea name="private_key" required rows="6"
                        class="w-full border rounded px-3 py-2 font-mono text-sm"
                        placeholder="-----BEGIN RSA PRIVATE KEY-----"></textarea>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Save GitHub App Configuration
                </button>
            </form>
        </div>

        <div id="github-configured" class="hidden">
            <div class="flex items-center gap-4">
                <span class="text-green-600">GitHub App configured</span>
                <a href="/auth/github/install" class="text-blue-600 hover:underline">Install on repositories</a>
            </div>
            <div id="github-installations" class="mt-2 text-sm text-gray-500"></div>
        </div>
    </div>

    <!-- Step 2: CLI API Keys -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2 text-gray-800">
                <span id="cli-status-icon" class="w-6 h-6 rounded-full bg-gray-500 flex items-center justify-center text-white text-sm">2</span>
                CLI API Keys
            </h2>
            <span id="cli-status" class="text-sm text-gray-500">No keys configured</span>
        </div>

        <p class="text-gray-600 mb-4">
            Configure API keys for the coding CLIs you want to use. At minimum, configure one.
        </p>

        <form id="cli-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1 text-gray-700">
                    Anthropic API Key
                    <span class="text-gray-500 font-normal">(for Claude Code, Aider)</span>
                </label>
                <input type="password" name="anthropic_api_key"
                    class="w-full border rounded px-3 py-2" placeholder="sk-ant-...">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1 text-gray-700">
                    OpenAI API Key
                    <span class="text-gray-500 font-normal">(for Codex, Aider)</span>
                </label>
                <input type="password" name="openai_api_key"
                    class="w-full border rounded px-3 py-2" placeholder="sk-...">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1 text-gray-700">
                    Google API Key
                    <span class="text-gray-500 font-normal">(for Gemini)</span>
                </label>
                <input type="password" name="google_api_key"
                    class="w-full border rounded px-3 py-2" placeholder="AIza...">
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Save API Keys
            </button>
        </form>

        <div id="configured-clis" class="mt-4 hidden">
            <h3 class="text-sm font-medium mb-2">Configured CLIs:</h3>
            <div id="cli-list" class="flex flex-wrap gap-2"></div>
        </div>
    </div>

    <!-- Step 3: Select Repositories -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2 text-gray-800">
                <span id="repos-status-icon" class="w-6 h-6 rounded-full bg-gray-500 flex items-center justify-center text-white text-sm">3</span>
                Repository Selection
            </h2>
            <span id="repos-status" class="text-sm text-gray-500">No repositories</span>
        </div>

        <p class="text-gray-600 mb-4">
            Select which repositories Cloud Code should monitor for issues.
        </p>

        <div id="repos-list" class="space-y-2">
            <p class="text-gray-500 italic">Complete GitHub App setup first to see repositories.</p>
        </div>
    </div>

    <!-- Complete -->
    <div id="setup-complete" class="hidden bg-green-50 border border-green-200 rounded-lg p-6 text-center">
        <h2 class="text-xl font-semibold text-green-800 mb-2">Setup Complete!</h2>
        <p class="text-green-700 mb-4">
            Cloud Code is ready. Add the <code class="bg-green-200 px-1 rounded">cloud-code</code> label
            to any issue to start automatic coding.
        </p>
        <a href="/" class="inline-block bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
            Go to Dashboard
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    document.getElementById('webhook-url').textContent = window.location.origin + '/webhooks/github/';
    await refreshStatus();

    document.getElementById('github-app-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        var formData = new FormData(e.target);
        var data = {};
        formData.forEach(function(value, key) { data[key] = value; });

        try {
            var response = await fetch('/api/credentials/github-app', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            });

            if (response.ok) {
                showMessage('GitHub App configured successfully!', 'success');
                await refreshStatus();
            } else {
                var error = await response.json();
                showMessage(error.detail || 'Failed to save', 'error');
            }
        } catch (err) {
            showMessage('Network error', 'error');
        }
    });

    document.getElementById('cli-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        var formData = new FormData(e.target);
        var data = {};
        formData.forEach(function(value, key) {
            if (value) data[key] = value;
        });

        if (Object.keys(data).length === 0) {
            showMessage('Please enter at least one API key', 'error');
            return;
        }

        try {
            var response = await fetch('/api/credentials/bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            });

            if (response.ok) {
                var result = await response.json();
                showMessage('Configured: ' + result.configured.join(', '), 'success');
                await refreshStatus();
            } else {
                var error = await response.json();
                showMessage(error.detail || 'Failed to save', 'error');
            }
        } catch (err) {
            showMessage('Network error', 'error');
        }
    });
});

async function refreshStatus() {
    try {
        var response = await fetch('/auth/status');
        var status = await response.json();
        updateUI(status);
    } catch (err) {
        console.error('Failed to fetch status:', err);
    }
}

function updateUI(status) {
    var completed = 0;

    if (status.github_app_configured) {
        completed++;
        document.getElementById('github-status').textContent = status.github_installations + ' installation(s)';
        document.getElementById('github-status-icon').className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-sm';
        document.getElementById('github-status-icon').textContent = 'OK';
        document.getElementById('github-not-configured').classList.add('hidden');
        document.getElementById('github-configured').classList.remove('hidden');
        document.getElementById('github-installations').textContent = status.github_installations + ' repository installation(s)';
    } else {
        document.getElementById('github-not-configured').classList.remove('hidden');
        document.getElementById('github-configured').classList.add('hidden');
    }

    if (status.cli_credentials_configured.length > 0) {
        completed++;
        document.getElementById('cli-status').textContent = status.cli_credentials_configured.length + ' configured';
        document.getElementById('cli-status-icon').className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-sm';
        document.getElementById('cli-status-icon').textContent = 'OK';

        document.getElementById('configured-clis').classList.remove('hidden');
        var cliHtml = status.cli_credentials_configured.map(function(cli) {
            return '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">' + cli + '</span>';
        }).join('');
        document.getElementById('cli-list').innerHTML = cliHtml;
    }

    if (status.github_installations > 0) {
        completed++;
        document.getElementById('repos-status').textContent = 'Repositories available';
        document.getElementById('repos-status-icon').className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-sm';
        document.getElementById('repos-status-icon').textContent = 'OK';
    }

    var percent = Math.round((completed / 3) * 100);
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-text').textContent = completed + '/3 completed';

    if (completed >= 2) {
        document.getElementById('setup-complete').classList.remove('hidden');
    }
}

function showMessage(text, type) {
    var container = document.getElementById('messages');
    var colorClass = type === 'success' ? 'bg-green-100 text-green-800 border-green-200' :
                     type === 'error' ? 'bg-red-100 text-red-800 border-red-200' :
                     'bg-blue-100 text-blue-800 border-blue-200';

    container.innerHTML = '<div class="p-4 rounded border ' + colorClass + '">' + text + '</div>';
    setTimeout(function() { container.innerHTML = ''; }, 5000);
}
</script>
{% endblock %}
